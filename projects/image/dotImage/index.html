<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>
<script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>

<div class="container" style="margin-top: 30px;">
<a class="btn btn-light" href="../..">< Back</a>
<hr>
<div class="row">
<div class="col"></div>
<div class="col-6">
  	

	<div class="input-group mb-3">
	  <div class="input-group-prepend">
	    <span class="input-group-text">Image:</span>
	  </div>
	  <div class="custom-file">
	    <input type="file" class="custom-file-input" id="input" accept="image/*" onchange="changeText(this.files)">
	    <label class="custom-file-label" id="inputLabel">Choose file</label>
	  </div>


	</div>

  <div style="display: none;" id="noFile" class="invalid-feedback">Enter an image!</div>

<hr>
        	

          <label for="colorBG" class="btn btn-light">
          <svg width="24" height="24">
            <rect id="colorBGLabel" x="1" y="1" rx="3" ry="3" width="20" height="20" style="fill:#FF0000;stroke:black" />
          </svg>
          Background Color
        </label>

        	<label for="colorDot" class="btn btn-light">
          <svg width="24" height="24">
            <rect id="colorLabel" x="1" y="1" rx="3" ry="3" width="20" height="20" style="fill:#FF0000;stroke:black" />
          </svg>
          Dot Color
        </label>

                  <input id="colorBG" style="opacity:0;" onchange="changeColor(this, 'colorBGLabel');" value="#FF0000" type="color">

        	<input id="colorDot" type="color" style="opacity:0;" onchange="changeColor(this, 'colorLabel');" value="#0000FF">

<hr>
<button class="btn btn-primary btn-lg btn-block" onclick="handleFiles(document.getElementById('input').files)">Go!</button>

<br>

        

   <div class="jumbotron" id="jumbo" style="display: none">
   	<div class="progress" id="pBar">
  <div id="dynamic" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
    <span id="current-progress"></span>
  </div>
</div>

   	<div class="row">
   	<div class="col">
      	<canvas style="max-width:100%;max-height:100%" class="img-thumbnail" id="imageCanvas"></canvas>
     </div>
     <div class="col" id="outCol">
     	<img id="loadingGIF" style="max-width:100%;max-height:100%;" class="img-thumbnail" src="https://i.redd.it/ounq1mw5kdxy.gif">
      	<canvas style="max-width:100%;max-height:100%;display: none" class="img-thumbnail" id="outputCanvas"></canvas>
  	</div>
  	</div>
   </div>
</div>
<div class="col"></div>

<script type="text/javascript">

	function padZero(str, len) {
    len = len || 2;
    var zeros = new Array(len).join('0');
    return (zeros + str).slice(-len);
}
	function invertColor(hex) {
    if (hex.indexOf('#') === 0) {
        hex = hex.slice(1);
    }
    // convert 3-digit hex to 6-digits.
    if (hex.length === 3) {
        hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }
    if (hex.length !== 6) {
        throw new Error('Invalid HEX color.');
    }
    // invert color components
    var r = (255 - parseInt(hex.slice(0, 2), 16)).toString(16),
        g = (255 - parseInt(hex.slice(2, 4), 16)).toString(16),
        b = (255 - parseInt(hex.slice(4, 6), 16)).toString(16);
    // pad each with zeros and return
    return '#' + padZero(r) + padZero(g) + padZero(b);
}

	function changeColor(elm, label) {
		l = document.getElementById(label);
		l.style.fill = elm.value;
		// l.style.color = invertColor(elm.value);
		// l.style.borderColor = invertColor(elm.value);
	}

	changeColor(document.getElementById('colorBG'), 'colorBGLabel')
	changeColor(document.getElementById('colorDot'), 'colorLabel')


	function changeText(f) {
		var fullPath = document.getElementById('input').value;
		if (fullPath) {
		    var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
		    var filename = fullPath.substring(startIndex);
		    if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
		        filename = filename.substring(1);
		    }
		    document.getElementById("inputLabel").innerHTML = filename
		}
	}

   function handleFiles(f) {

   	

   	var file = document.getElementById('input').files[0];
    if (file == undefined) {
      $("#input").addClass("is-invalid");
      $('#noFile').show();
      return
    }
    $('#noFile').hide();
    $("#input").removeClass("is-invalid");
   	// if (!file.type.startsWith('image/')){ continue }
   
   	var img = document.createElement("img");
   	img.classList.add("obj");
   	img.file = file;
   	img.id = "imgPre"
   	// document.getElementById("preview").appendChild(img); // Assuming that "preview" is the div output where the content will be displayed.
   
   	var reader = new FileReader();
   	reader.onload = (function(aImg) { 
   
   		return function(e) {   
   			var dataURL = reader.result;
   			readImage(dataURL);
   
   		};
   
   		 
   	})(img);
   
   	reader.readAsDataURL(file);
   
   	function readImage(dataURL) {
   		document.getElementById("loadingGIF").src = "https://i.redd.it/ounq1mw5kdxy.gif";

   		var canvas = document.getElementById("imageCanvas");
   		var ctx = canvas.getContext("2d");
   		var outCanvas = document.getElementById("outputCanvas");
   		var outCtx = outCanvas.getContext("2d");
   		var image = new Image();

   		image.onload = function() {
   			canvas.width = image.width;
   			canvas.height = image.height;
   			outCanvas.width = image.width;
   			outCanvas.height = image.height;
   			ctx.drawImage(image, 0, 0);
   			outCtx.font = "300px Arial";
			outCtx.fillText("Loading ...",image.width/2 - 500,image.height/2 - 500);
			outCtx.fillStyle = document.getElementById("colorBG").value;
   			setTimeout(parseData, 50);



   		};
   		image.src = dataURL;
		document.getElementById("jumbo").style.display = "block";
   
   	}
   	
   }

   function parseData() {
   	var canvas = document.getElementById("imageCanvas");
	var ctx = canvas.getContext("2d");
	var outCanvas = document.getElementById("outputCanvas");
	var outCtx = outCanvas.getContext("2d");
	var lastvaleur = 0;
	outCtx.fillRect(0, 0, canvas.width, canvas.height);
	var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
   	for (var i=0;i<imgData.data.length;i+=4) {

			var d = imgData.data.slice(i,i+4);
			var r = Math.random()
			var inverted = (d[0] + d[1] + d[2])/3
			if (r * 255 > inverted) {
				outCtx.fillStyle = document.getElementById("colorDot").value;
				outCtx.fillRect((i/4) % canvas.width, i/(4 *  canvas.width), 1, 1)
			}
   							 
   		  }
   	// document.getElementById("loadingGIF").style.display = "none";

   	loadingGIF.src = outCanvas.toDataURL("image/png");
   	
   }

</script>