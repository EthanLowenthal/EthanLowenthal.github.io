<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>
<script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>

<style>
.collapsible {
  cursor: pointer;
  outline: none;
  font-size: 15px;
}


.collapsible.active:after {
  content: "-";
}

.collapsible:after {
  content: "+";
  float: right;
}

.content {
  padding: 0 18px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
  /*background-color: #f1f1f1;*/
}
</style>

<div class="container" style="margin-top: 30px;">
<a class="btn btn-light" href="../..">< Back</a>
<hr>
<div class="row">
<div class="col"></div>
<div class="col-6">
  	
      <div class="input-group mb-3">
    <div class="input-group-prepend">
      <span class="input-group-text">Image:</span>
    </div>
    <div class="custom-file">
      <input type="file" class="custom-file-input" id="input" accept="image/*" onchange="changeText(this.files)">
      <label class="custom-file-label" id="inputLabel">Choose file</label>
        <div style="display: none;" id="noFile" class="invalid-tooltip">
          Please upload an image.
        </div>
    </div>


  </div>

<hr>
  <button class="btn btn-outline-secondary collapsible btn-block">Options</button>

  <div class="content">
  <br>
<form class="form-inline">
  <label for="iterations">Number of iterations: </label>
  <input type="number" min="0" style="margin-left:5px; width: 30%;" value="1000" id="iterations" class="form-control">
</form>

<form class="form-inline">
  <label for="iterationBalls">Balls added per iteration: </label>
  <input type="number" min="0" style="margin-left:5px; width: 30%;" value="10" id="iterationBalls" class="form-control">
</form>
  
<form class="form-inline">
<div class="form-check">
  <input class="form-check-input position-static" type="checkbox" onchange="settingCheckbox(this, 'maxSize')" id="maxSizeCheck">
</div>
  <label for="maxSize">Max circle size: </label>
  <input type="number" min="0" style="margin-left:5px; width: 30%;" id="maxSize" class="form-control" disabled>
</form>

<form class="form-inline">
<div class="form-check">
  <input class="form-check-input position-static" type="checkbox" onchange="settingCheckbox(this, 'minSize')" id="minSizeCheck">
</div>
  <label for="minSize">Min circle size: </label>
  <input type="number" value="2" min="0" style="margin-left:5px; width: 30%;" id="minSize" class="form-control" disabled>
</form>
</div>
<hr>
<button class="btn btn-primary btn-lg btn-block" onclick="handleFiles(document.getElementById('input').files)">Go!</button>

<br>

        

   <div class="jumbotron" id="jumbo" style="display: none">

   	<div class="row">
   	<div class="col">
      	<canvas style="max-width:100%;max-height:100%" class="img-thumbnail" id="imageCanvas"></canvas>
     </div>
     <div class="col" id="outCol">
      <img id="loadingGIF" style="max-width:100%;max-height:100%;" class="img-thumbnail" src="https://i.redd.it/ounq1mw5kdxy.gif">
        <canvas style="max-width:100%;max-height:100%;display: none" class="img-thumbnail" id="outputCanvas"></canvas>
  	</div>
  	</div>
   </div>
</div>
<div class="col"></div>

<script>
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.maxHeight){
      content.style.maxHeight = null;
    } else {
      content.style.maxHeight = content.scrollHeight + "px";
    } 
  });
}
</script>

<script type="text/javascript">


	function changeText(f) {
		var fullPath = document.getElementById('input').value;
		if (fullPath) {
		    var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
		    var filename = fullPath.substring(startIndex);
		    if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
		        filename = filename.substring(1);
		    }
		    document.getElementById("inputLabel").innerHTML = filename
        $('#noFile').hide();
		}
	}

  function settingCheckbox(c, i) {
    if (c.checked) {
      $("#"+i).removeAttr("disabled");
    } else {
      $("#"+i).attr("disabled", "disabled");
    }
  }

   function handleFiles(f) {


   	var file = document.getElementById('input').files[0];
    if (file == undefined) {
      $("#input").addClass("is-invalid");
      $('#noFile').show();
      return
    }
    $('#noFile').hide();
    $("#input").removeClass("is-invalid");
   
   	var img = document.createElement("img");
   	img.classList.add("obj");
   	img.file = file;
   	img.id = "imgPre"   
   	var reader = new FileReader();
   	reader.onload = (function(aImg) { 
   
   		return function(e) {   
   			var dataURL = reader.result;
   			readImage(dataURL);
   
   		};
   
   		 
   	})(img);
   
   	reader.readAsDataURL(file);
   
   	function readImage(dataURL) {
      document.getElementById("loadingGIF").src = "https://i.redd.it/ounq1mw5kdxy.gif"

   		var canvas = document.getElementById("imageCanvas");
   		var ctx = canvas.getContext("2d");
   		var outCanvas = document.getElementById("outputCanvas");
   		var outCtx = outCanvas.getContext("2d");
   		var image = new Image();

   		image.onload = function() {
   			canvas.width = image.width;
   			canvas.height = image.height;
   			outCanvas.width = image.width;
   			outCanvas.height = image.height;
   			ctx.drawImage(image, 0, 0);
   			setTimeout(parseData, 50);



   		};
   		image.src = dataURL;
		document.getElementById("jumbo").style.display = "block";
   
   	}
   	
   }

var rgbToHex = function (rgb) { 
  var hex = Number(rgb).toString(16);
  if (hex.length < 2) {
       hex = "0" + hex;
  }
  return hex;
};

   var fullColorHex = function(r,g,b) {   
  var red = rgbToHex(r);
  var green = rgbToHex(g);
  var blue = rgbToHex(b);
  return "#"+red+green+blue;
};

   class circle {
    constructor(pos, color) {
      this.pos = pos;
      this.color = fullColorHex(color[0], color[1], color[2]);
      this.r = 1;
      this.growing = true;
    }
    update(context){
      this.r++;
      if (document.getElementById('maxSizeCheck').checked) {
        if (this.r >= $("#maxSize").val()) {
          this.growing = false;
        }
      }
    }
    collide(c2) {
      var dx = (this.pos[0] - c2.pos[0]) * (this.pos[0] - c2.pos[0]);
      var dy = (this.pos[1] - c2.pos[1]) * (this.pos[1] - c2.pos[1]);
      var sumR = (this.r + c2.r) * (this.r + c2.r); 

      if(dx + dy <= sumR){
        this.growing = false;
        c2.growing = false;
      }


    }
   }


   function addNewCircle(circles, outCanvas, pixels) {
      randCircle = Math.floor(Math.random()*pixels.length)
      var x = randCircle % outCanvas.width;
      var y = Math.floor(randCircle / outCanvas.width);
      circles.push(new circle([x,y], pixels[randCircle]))
      return circles
   }

   function parseData() {
   	var canvas = document.getElementById("imageCanvas");
  	var ctx = canvas.getContext("2d");
  	var outCanvas = document.getElementById("outputCanvas");
  	var outCtx = outCanvas.getContext("2d");
  	var lastvaleur = 0;
    outCtx.fillStyle = "white";
  	outCtx.fillRect(0, 0, canvas.width, canvas.height);
  	var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var pixels = []
   	for (var i=0;i<imgData.data.length;i+=4) {

			var d = imgData.data.slice(i,i+4);
			pixels.push(d)
   							 
   		  }
    var circles = []
    for (ticks=0;ticks<$("#iterations").val();ticks++) {

      for (newC=0;newC<$("#iterationBalls").val();newC++) {
        circles = addNewCircle(circles, outCanvas, pixels);
      }

    for (i=0;i<circles.length;i++) {

      if (circles[i].growing) {

        circles[i].update(outCtx)
        var ccCircles = circles.slice(0,i)

        for (cc=0;cc < ccCircles.length;cc++) {
          circles[i].collide(ccCircles[cc])
        }

        var ccCircles = circles.slice(i+1,circles.length)

        for (cc=0;cc<ccCircles.length;cc++) {
          circles[i].collide(ccCircles[cc])
        }
      } 

    }

  }

    for (i=0;i<circles.length;i++){
      if (document.getElementById('minSizeCheck').checked) {
        
        if(circles[i].r > $('#minSize').val()){
        outCtx.beginPath();
        outCtx.arc(circles[i].pos[0], circles[i].pos[1], circles[i].r, 0, 2 * Math.PI, false);
        outCtx.fillStyle = circles[i].color;
        outCtx.fill();

      }} else if (circles[i].r > 2) {

        outCtx.beginPath();
        outCtx.arc(circles[i].pos[0], circles[i].pos[1], circles[i].r, 0, 2 * Math.PI, false);
        outCtx.fillStyle = circles[i].color;
        outCtx.fill();
      } }

    
    loadingGIF.src = outCanvas.toDataURL("image/png");


   }

</script>