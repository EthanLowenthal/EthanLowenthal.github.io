<head>
	<title>PGP Tool</title>
</head>
<body>
<div style="margin-top: 25px; margin-left: 50px">
<a class="btn btn-light" href="..">< Back</a>
<hr>
<ul class="nav nav-pills">
  <li class="nav-item">
	<a class="nav-link active" onclick="switchEncrypt()" id="navEncode">Encode</a>
  </li>
  <li class="nav-item">
	<a class="nav-link" onclick="switchDecrypt()" id="navDecode">Decode</a>
  </li>
  <li class="nav-item">
	<a class="nav-link" onclick="switchGenerate()" id="navGenerate">Generate Keys</a>
  </li>
</ul>

<hr>
<div class="container" id="divEncode", style="display: block">
	<form>
		<label for="public_key">Key:</label>
		<textarea class="form-control" name="pkey" id="public_key" rows="10" cols="50"></textarea><br>

		<label for="message2">Message:</label>
		<textarea class="form-control" name="smessage" id="message2" rows="10" cols="50"></textarea><br>

		<button type="button" class="btn btn-dark" id="encrypt">Encode</button>
 

	</form>
</div>
<div class="container" id="divDecode", style="display: none">
	<form>
		<label for="private_key">Key:</label>
		<textarea class="form-control" id="private_key" rows="10" cols="50"></textarea><br>

		<label for="passphrase">Passphrase:</label>
		<input class="form-control" type="text" id="passphrase"><br>

		<label for="message">Message:</label>
		<textarea class="form-control" id="message" rows="10" cols="50"></textarea><br>

		<button type="button" class="btn btn-dark" id="decrypt">Decode</button>


	</form>
</div>
<div class="container" id="divGenerate", style="display: none">

	<form>
		<div id="progress" class="alert alert-info" style="display: none"></div>  
		<label for="pass">Passphrase:</label>
		<input class="form-control" id="pass" type="text"><br>

		<label for="privkey">Private Key:</label>
		<textarea class="form-control" id="privkey" rows="10" disabled></textarea><br>

		<label for="pubkey">Public Key:</label>
		<textarea class="form-control" id="pubkey" rows="10" disabled></textarea><br>

		
		<button type="button" class="btn btn-dark"  id="generate">Generate</button>

	</form>
</div>


</div>
<script src="./js/popper.js"></script>
<script src="./js/jquery/jquery.js"></script>
<script src="./js/jquery/jquery-ui.js"></script>
<link rel="stylesheet" href="./js/bootstrap/bootstrap.css">
<script src="./js/bootstrap/bootstrap.js"></script>
<script src="./js/kbpgp/kbpgp-2.0.8.js"></script>
<script src="./js/foundation.js"></script>
<script src="./js/modernizr.js"></script>
<script src="./js/placeholder.js"></script>
<script src="./js/index.js"></script>


<script type="text/javascript">
	function switchEncrypt(){
		document.getElementById("navEncode").classList.add('active');
		document.getElementById("navDecode").classList.remove('active');
		document.getElementById("navGenerate").classList.remove('active');

		document.getElementById("divEncode").style.display = "block";
		document.getElementById("divDecode").style.display = "none";
		document.getElementById("divGenerate").style.display = "none";


	}

	function switchDecrypt(){
		document.getElementById("navDecode").classList.add('active');
		document.getElementById("navEncode").classList.remove('active');
		document.getElementById("navGenerate").classList.remove('active');

		document.getElementById("divEncode").style.display = "none";
		document.getElementById("divDecode").style.display = "block";
		document.getElementById("divGenerate").style.display = "none";
	}

	function switchGenerate(){
		document.getElementById("navGenerate").classList.add('active');
		document.getElementById("navDecode").classList.remove('active');
		document.getElementById("navEncode").classList.remove('active');

		document.getElementById("divEncode").style.display = "none";
		document.getElementById("divDecode").style.display = "none";
		document.getElementById("divGenerate").style.display = "block";
	}
</script>

<script type="text/javascript">
		$(document).ready(function () {
			$("#decrypt").click(function () {
				var priv_key = $('textarea#private_key').val();
				var passphrase = $('input#passphrase').val();
				var message = $('textarea#message').val();
				var privkey;
				kbpgp.KeyManager.import_from_armored_pgp({
					armored: priv_key
				}, function (err, pk) {
					if (!err) {
						if (pk.is_pgp_locked()) {
							pk.unlock_pgp({
								passphrase: passphrase
							}, function (err) {
								if (!err) {
									console.log("Loaded private key with passphrase");
									privkey = pk;
								} else {
									console.log("Error: " + err);
									return $('textarea#output').val(err);
									return;
								}
							});
						} else {
							console.log("Loaded private key w/o passphrase");
						}
					}
				});
				kbpgp.unbox({keyfetch: privkey, armored: message}, function (err, literals) {
					if (err != null) {
						console.log("Error: " + err);
						return $('textarea#message').val(err);
					} else {
						console.log("decrypted message");
						$('textarea#message').val(literals[0].toString());
						var ds = km = null;
						ds = literals[0].get_data_signer();
						if (ds) {
							km = ds.get_key_manager();
						}
						if (km) {
							console.log("Signed by PGP fingerprint");
							console.log(km.get_pgp_fingerprint().toString('hex'));
							$('input#fingerprint').val(km.get_pgp_fingerprint().toString('hex'));
						}
					}
				});
			});

			$("#encrypt").click(function () {
				var priv_key = $('textarea#private_key').val();
				var pub_key = $('textarea#public_key').val();
				var passphrase = $('input#passphrase').val();
				var message = $('textarea#message2').val();
				var pubkey, privkey;
				kbpgp.KeyManager.import_from_armored_pgp({
					armored: pub_key
				}, function (err, alice) {
					if (!err) {
						console.log("Loaded public key");
						pubkey = alice;
					}
				});
				kbpgp.KeyManager.import_from_armored_pgp({
					armored: priv_key
				}, function (err, chuck) {
					if (!err) {
						if (chuck.is_pgp_locked()) {
							chuck.unlock_pgp({
								passphrase: passphrase
							}, function (err) {
								if (!err) {
									console.log("Loaded private key with passphrase");
									privkey = chuck;
								}
							});
						} else {
							console.log("Loaded private key w/o passphrase");
						}
					}
				});
				var params = {
					encrypt_for: pubkey,
					sign_with: privkey,
					msg: message,
				};
				kbpgp.box(params, function (err, result_string, result_buffer) {
					console.log(err, result_string, result_buffer);
					if (err != null) {
						$('textarea#message2').val(err);
					} else {
						$('textarea#message2').val(result_string);
					}
				});
			});

			$("#generate").click(function () {
				document.getElementById("progress").style.display = "block";
				var asp = new kbpgp.ASP({
					progress_hook: function (o) {
						var msg;
						switch (o.what) {
							case"fermat":
								msg = "Searching for a prime - " + o.p.toString().slice(-3);
								break;
							case"mr":
								msg = "Confirming prime " + ~~(100 * o.i / o.total) + "%";
								break;
							case"found":
								msg = "Successful!";
								break;
							default:
								msg = "" + o.what
						}
						$('#progress').text(msg);
					}
				});

				var F = kbpgp["const"].openpgp;
				var opts = {
					asp: asp,
					userid: "",
					primary: {
						nbits: 4096,
						flags: F.certify_keys | F.sign_data | F.auth | F.encrypt_comm | F.encrypt_storage,
						expire_in: 0
					},
					subkeys: [
						{
							nbits: 2048,
							flags: F.sign_data,
							expire_in: 86400 * 365 * 8
						}, {
							nbits: 2048,
							flags: F.encrypt_comm | F.encrypt_storage,
							expire_in: 86400 * 365 * 8
						}
					]
				};

				kbpgp.KeyManager.generate(opts, function (err, gen) {
					if (!err) {
						gen.sign({}, function (err) {
							console.log(gen);
							gen.export_pgp_private({
								passphrase: $('input#pass').val()
							}, function (err, pgp_private) {
								console.log("private key: ", pgp_private);
								document.getElementById("progress").style.display = "none";
								$('textarea#privkey').val(pgp_private);
								$('textarea#privkey').prop("disabled", false);

							});
							gen.export_pgp_public({}, function (err, pgp_public) {
								console.log("public key: ", pgp_public);
								$('textarea#pubkey').val(pgp_public);
								$('textarea#pubkey').prop("disabled", false);


							});
						});
					}
				});
			});
		})
		;
	
	

</script>
</body>
